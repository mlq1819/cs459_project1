#ifndef DEBUG
#define DEBUG true
#endif
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <iostream>
#include <cstdlib>
#include <stdlib.h>
#include <string>
#include "program1.h"

using namespace std;

void generate(char * str, unsigned int len){
	for(unsigned int i=0; i<len; i++){
		str[i]='s';
	}
}

int main(int argc, char** argv){
#if DEBUG
cout << "In prgm1_stack_exploit:\n[";
for(int i=0; i<argc; i++){
	if(i>0)
		cout << ", ";
	cout << "\"" << argv[i] << "\"";
}
cout << "]" << endl;
#endif
	char ** args;
	if(argc>=3)
		args = (char **) malloc(sizeof(char *) * argc);
	else
		args = (char **) malloc(sizeof(char *) * (argc+1));
	string prog_name  = "./program1.cpp";
	args[0] = (char *) malloc(sizeof(char) * prog_name.length());
	for(unsigned int i=0; i<prog_name.length(); i++){
		args[0][i] = prog_name.c_str()[i];
	}
	for(int j=1; j<argc; j++){
		args[j] = (char *) malloc(sizeof(char) * strlen(argv[j]));
		for(unsigned int i=0; i<strlen(argv[j]); i++){
			args[j][i] = argv[j][i];
		}
	}
	if(argc<3){
		char overflow[BUFSIZE+1];
		generate(overflow, BUFSIZE+1);
		args[argc] = (char *) malloc(sizeof(char) * strlen(overflow));
		for(unsigned int i=0; i<strlen(overflow); i++){
			args[argc][i] = overflow[i];
		}
	}
	
#if DEBUG
cout << "[";
for(int i=0; i<argc; i++){
	if(i>0)
		cout << ", ";
	cout << "\"" << args[i] << "\"";
}
cout << "]" << endl;
#endif
	int toReturn = prog_main(argc, args);
	for(int i=0; i<argc; i++){
		free(args[i]);
		args[i]=NULL;
	}
	if(argc<3){
		free(args[argc]);
		args[argc]=NULL;
	}
	free(args);
	args=NULL;
	return toReturn;
}


/*
	string prog_name  = "./program1.cpp";
	size_t length = prog_name.length() + ((unsigned int) argc-1);
#if DEBUG
cout << "\tlength=" << length << endl;
#endif
	for(int i=1; i<argc; i++){
		length += strlen(argv[i]) + 1;
#if DEBUG
cout << "\t" << argv[i] << " : length=" << length << endl;
#endif
	}
	char * args = (char *) malloc(sizeof(char) * length);
	unsigned int index;
	for(index=0; index<prog_name.length(); index++){
		args[index] = prog_name.c_str()[index];
#if DEBUG
cout << "\t\targs[" << index << "] = " << args[index] << endl;
#endif
	}
	for(int j=1; j<argc; j++){
		args[index] = ' ';
#if DEBUG
cout << "\t\targs[" << index << "] = " << args[index] << endl;
#endif
		index++;
		for(unsigned int i=0; i<strlen(argv[j]) && index<length; i++){
			args[index] = argv[j][i];
#if DEBUG
cout << "\t\targs[" << index << "] = " << args[index] << endl;
#endif
			index++;
		}
	}
*/